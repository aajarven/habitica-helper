# Helper for Running Tasks in Habitica Parties
This tool allows automating some tedious tasks that are required when running challenges and choosing their winners. The UI relies heavily on hard-coded values: the most valuable thing for others are likely the classes the UI uses. To be honest that's also what I'm using nowadays too, as instead of running the commands manually, I have a bot that does that (see https://github.com/aajarven/habot).

Currently the supported functionalities accessible from the command line UI include:
 - picking the winner of a weekly challenge
 - listing Habitica birthdays of party members and updating them to a google calendar

For developer use, `habitica_helper` package contains following representations of Habitica concepts / functionalities:
 - Habitica users
 - Habitica tasks (habits, dailies, and todos)
 - Picking random integers based on recent stock data
 - Fetching party member data
 - Representing and operating on existing Habitica challenges

## Installation from Source
This helper is written using Python, so you'll need to ensure it is installed to begin with (see https://www.python.org/). Any version beyond 3.6 should work.

You'll also need `pip`, but that's likely installed along with python. If it isn't, see e.g. https://pip.pypa.io/en/stable/installing/.

First, download the contents of this repository. Then navigate on command line to the directory you downloaded it into, and install the required packages:
```
pip install -r requirements.txt
```

Then you'll need to create a configuration file with your user ID and API key. The easiest way to do this is to copy the file `conf/secrets/habitica_credentials_template.py` to `conf/secrets_habitica_credentials.py`, and then use your favourite text editor to replace `yourUID` and `yourToken` with ones from your Habitica settings page. Never reveal that `secrets.py` file to anyone else.

Now you are ready to use the helper tool. These steps need to be done only once.

## Usage
Now you can invoke the helper tool using command line. The command
```
python hhelper.py
```
shows you help for different functionalities this helper tool has. For checking the winner of the newest Sharing Weekend challenge for our party, you can use
```
python hhelper.py sharing-winners
```


## Picking a Challenge Winner: Under the Hood
The helper is able to determine the winner for the newest challenge with a certain string in its name. So, how does that work?

First, the newest matching challenge is found, and a list of users who are eligible for winning it is created. This is done simply by listing all participants who have ticked all To-Do tasks for the challenge. This list is also printed so it's possible to confirm that all eligible users are indeed listed.

Then, the winner is picked. This is the more complicated part, as the program makes sure that whoever runs the winner picking command for a specific week will get the same winner. This means that fairness of the selection can be verified by any party member.

To understand the mathematical background of the method, one has to first be familiar with how (pseudo)random numbers are generated by a computer. In essence, the computer starts from some initial (usually not-random) number, called the [seed](https://en.wikipedia.org/wiki/Random_seed), and applies pre-determined operations on that number to come up with a sequence of new numbers. These numbers are the pseudorandom numbers generated by the algorithm.

The interesting part is that as these operations are deterministic, setting the same seed will always result in the same random numbers. Thus, in order to get a verifiable winner for a challenge, we'll just have to pick the seed in a verifiable way. Ideally the seed also wouldn't be public before the challenge is over, as this makes it impossible to tamper with the result. In this case that is not critical though: it's not possible to e.g. participate in the challenge with a fake profile after determining that adding one more participant would make the player win.

This implementation uses the stock market as a source for the seed. The seed is chosen based on the Amsterdam Stock Exchange index values from the current week Tuesday, fetched using [Yahoo! finance](https://finance.yahoo.com/quote/%5EAEX). The seed consists of decimal parts of opening, high, low and closing prices for the day in that order, i.e. if the prices are e.g.

| Value type | Price (EUR) |
|------------|-------------|
| Open       | 506.95      |
| High       | 506.95      |
| Low        | 485.73      |
| Close      | 490.66      |

the seed will be 95957366. Note that all other values except the opening value can (and likely will) change during the day, so the winner has to be determined after the selected stock closes for the Tuesday, i.e. 5:40 PM Amsterdam time (GMT+1).

After setting the seed, the program uses the random number generator to draw the winner for the challenge. To make it easier to verify that there were no errors, in addition to the selected winner the program outputs:
- the name of the challenge
- a list of eligible winners
- date for which the stock values were used as the seed
- the resulting seed

Running the program can look e.g. like this:
```
$ python hhelper.py sharing-winners
Eligible winners for challenge "Sharing Weekend March 7âˆ’9" are:
- Some Name (@SomeUser)
- AnotherUser (@AnotherUser)
- ThirdUser (@thirdy)
- fourth (@last-boye)

Using stock data from 2020-03-10 from ^AEX (seed 95957366).

ThirdUser (@thirdy) wins the challenge!
```

As the seed is set from a publicly available source of randomness, anyone can confirm the result.
